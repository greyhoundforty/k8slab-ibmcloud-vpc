# Ansible Configuration for Kubernetes on IBM Cloud

This directory contains Ansible playbooks and roles for deploying and configuring a Kubernetes cluster on IBM Cloud infrastructure.

## Overview

These Ansible playbooks automate the deployment of a production-ready Kubernetes cluster using kubeadm on IBM Cloud VPC infrastructure. The configuration includes:

- A secure bastion host for cluster management
- Multi-node Kubernetes control plane
- Scalable worker nodes
- Calico CNI networking
- Proper security configurations

## Directory Structure

```
ansible/
├── inventory.ini            # Generated by Terraform
├── roles/                   # Ansible roles
│   ├── bastion/             # Bastion host configuration
│   ├── common/              # Common settings for all nodes
│   ├── kube-base/           # Base Kubernetes components
│   ├── kube-controller/     # Kubernetes control plane setup
│   └── kube-worker/         # Kubernetes worker node setup
├── site.yaml                # Main playbook
├── ping.yaml                # Connectivity test playbook
└── templates/               # Jinja2 templates
    └── inventory.tftpl      # Template for Terraform-generated inventory
```

## Playbooks

- **site.yaml**: Main playbook that applies all roles in the correct order
- **ping.yaml**: Simple playbook to verify connectivity to all hosts

## Roles

1. **common**: Updates and prepares all systems
2. **bastion**: Configures the bastion host as a management server
3. **kube-base**: Installs containerd and Kubernetes components on all nodes
4. **kube-controller**: Initializes the Kubernetes control plane
5. **kube-worker**: Joins worker nodes to the cluster

## Usage

The playbooks are designed to be run by Terraform using the `local-exec` provisioner, but can also be run manually:

```bash
# Verify connectivity to all hosts
ansible-playbook -i inventory.ini ping.yaml

# Deploy the full Kubernetes cluster
ansible-playbook -i inventory.ini site.yaml
```

## Variables

The playbooks and roles use variables from the Terraform-generated inventory file. Key variables include:

- Controller and worker node IP addresses
- Bastion host public IP address
- Region information

## Notes

- The inventory file is dynamically generated by Terraform
- The bastion host is used as a jump host to access private nodes
- Kubernetes version 1.32.2-1.1 is installed
- Calico CNI is used for pod networking
- The kubeconfig file is automatically copied to the bastion for cluster management

## Requirements

- Ansible 2.9+
- SSH access to all nodes via the bastion host
- Terraform-created infrastructure on IBM Cloud

## Integration with Terraform

The Ansible module in Terraform calls these playbooks after provisioning the infrastructure. The workflow is:

1. Terraform creates VPC, subnets, and VMs
2. Terraform generates the Ansible inventory
3. Terraform executes the Ansible playbooks
4. Ansible configures the Kubernetes cluster

## Troubleshooting

If you encounter issues:

1. Check connectivity using the ping.yaml playbook
2. Verify the inventory file has correct hostnames and IP addresses
3. Ensure SSH access is properly configured
4. Check the system logs on the affected nodes
